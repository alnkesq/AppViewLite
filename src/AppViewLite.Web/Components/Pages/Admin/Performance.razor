@page "/debug/performance"

@layout AppViewLite.Web.Components.Layout.NoLayout
@inject RequestContext RequestContext
<PageTitle>Performance by task kind</PageTitle>
<div style="margin-left: 10px;">
    <h3>Performance by task kind</h3>
    <a class="blue-link" href="/debug">Debug</a> |
    <a class="blue-link" href="/debug/requests">Requests</a>
    @if (Context != null)
    {
        <text> | </text><a class="blue-link" href="/debug/performance">Show all</a>
    }
</div>
@code {
    [Parameter][SupplyParameterFromQuery] public string? Context { get; set; }

    protected override void OnInitialized()
    {
        RequestContext.EnsureAdministrator();
    }
}

@{
    var types = AppViewLiteInit.GlobalPerformanceStatsByOperation
    .Select(x => (x.Key.RequestContextKind, x.Key.TableName, x.Key.Operation, x.Value.Count, x.Value.Total))
    .Where(x => Context == null || x.RequestContextKind == Context)
    .OrderByDescending(x => x.Total.StopwatchTicks)
    .ToArray();
    var totalTime = types.Sum(x => x.Total.StopwatchTicks);
}

<table class="debug-table">
    <tr>
        <th>Context type</th>
        <th>Table</th>
        <th>Operation</th>
        <th>Time (%)</th>
        <th>Time</th>
        <th>Seek time</th>
        <th>IO Read bytes</th>
        <th>IO Reads</th>
        <th>Potential mmap</th>
        <th>Count</th>
        <th>Avg time</th>
    </tr>
    @foreach (var row in types)
    {
        var color = row.TableName != null && row.Operation != null ? Program.HashToCssColor(row.TableName, row.Operation) : "transparent";
        <tr>
            <td><a href="/debug/performance?context=@(Uri.EscapeDataString(row.RequestContextKind))">@row.RequestContextKind</a></td>
            <td style="background-color: @color">@row.TableName</td>
            <td style="background-color: @color">@row.Operation</td>
            <td>@(Math.Round(100.0 * row.Total.StopwatchTicks / totalTime))%</td>
            <td>@StringUtils.ToHumanTimeSpanPrecise(BlueskyRelationshipsClientBase.StopwatchTicksToTimespan(row.Total.StopwatchTicks))</td>
            <td>@StringUtils.ToHumanTimeSpanPrecise(BlueskyRelationshipsClientBase.StopwatchTicksToTimespan(row.Total.SeekStopwatchTicks))</td>
            <td>@StringUtils.ToHumanBytes(row.Total.IoReadBytes)</td>
            <td>@row.Total.IoReads</td>
            <td>@StringUtils.ToHumanBytes(row.Total.MmapPotentialReadBytes)</td>
            <td>@row.Count</td>
            <td>@StringUtils.ToHumanTimeSpanForProfiler(BlueskyRelationshipsClientBase.StopwatchTicksToTimespan(row.Total.SeekStopwatchTicks / row.Count))</td>
        </tr>
    }
</table>
